---
import NewsCard from './NewsCard.astro';
import newsData from '../data/news-carousel.json';
---

<section id="news-carousel" class="py-16 bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="max-w-7xl mx-auto px-6 lg:px-8">
    <div class="grid lg:grid-cols-4 gap-8 items-center">
      <!-- Título de la sección -->
      <div class="lg:col-span-1">
        <div class="text-center lg:text-left">
          <h2 class="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-4">
            Últimas Noticias ISO
          </h2>
          <p class="text-lg text-gray-600 mb-6">
            Mantente actualizado con las últimas tendencias, regulaciones y mejores prácticas en gestión ISO.
          </p>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full font-semibold transition-colors duration-300">
            Ver Todas las Noticias
          </button>
        </div>
      </div>

      <!-- Carousel de noticias -->
      <div class="lg:col-span-3">
        <div class="relative">
          <!-- Contenedor del carousel -->
          <div 
            id="news-carousel-container" 
            class="overflow-hidden rounded-xl"
          >
            <div 
              id="news-track" 
              class="flex transition-transform duration-500 ease-in-out"
              style="transform: translateX(0%)"
            >
              {newsData.map((noticia) => (
                <div class="w-full md:w-1/2 lg:w-1/3 flex-shrink-0">
                  <NewsCard noticia={noticia} />
                </div>
              ))}
            </div>
          </div>

          <!-- Controles de navegación -->
          <button 
            id="news-prev-btn"
            class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-10 backdrop-blur-sm"
            aria-label="Noticia anterior"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>

          <button 
            id="news-next-btn"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-10 backdrop-blur-sm"
            aria-label="Siguiente noticia"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>

        <!-- Indicadores de puntos -->
        <div class="flex justify-center mt-6 space-x-2" id="news-dots-container">
          <!-- Los dots se generarán dinámicamente con JavaScript -->
        </div>

        <!-- Indicador de progreso -->
        <div class="mt-4">
          <div class="bg-gray-200 rounded-full h-1">
            <div id="progress-bar" class="bg-blue-600 h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const track = document.getElementById('news-track') as HTMLElement | null;
    const prevBtn = document.getElementById('news-prev-btn') as HTMLButtonElement | null;
    const nextBtn = document.getElementById('news-next-btn') as HTMLButtonElement | null;
    const dotsContainer = document.getElementById('news-dots-container') as HTMLElement | null;
    const progressBar = document.getElementById('progress-bar') as HTMLElement | null;
    
    if (!track || !prevBtn || !nextBtn || !dotsContainer) return;

    const cards = track.children;
    const totalNews = cards.length;
    
    // Configuración responsive
    let newsPerView = 1;
    let currentIndex = 0;
    let autoplayInterval: number;
    let autoplayDuration = 5000; // 5 segundos
    let progressInterval: number;

    // Función para determinar cuántas noticias mostrar según el tamaño de pantalla
    function updateNewsPerView() {
      if (window.innerWidth >= 1024) {
        newsPerView = 3; // lg: 3 noticias
      } else if (window.innerWidth >= 768) {
        newsPerView = 2; // md: 2 noticias
      } else {
        newsPerView = 1; // sm: 1 noticia
      }
    }

    // Calcular el número total de páginas
    function getTotalPages() {
      return Math.ceil(totalNews / newsPerView);
    }

    // Crear indicadores de puntos
    function createDots() {
      if (!dotsContainer) return;
      dotsContainer.innerHTML = '';
      const totalPages = getTotalPages();
      
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement('button');
        dot.className = `w-3 h-3 rounded-full transition-all duration-300 ${
          i === 0 ? 'bg-blue-600 w-8' : 'bg-gray-300 hover:bg-gray-400'
        }`;
        dot.setAttribute('aria-label', `Ir a la página ${i + 1}`);
        dot.addEventListener('click', () => goToPage(i));
        dotsContainer.appendChild(dot);
      }
    }

    // Actualizar la barra de progreso
    function updateProgressBar() {
      if (!progressBar) return;
      const currentPage = Math.floor(currentIndex / newsPerView);
      const totalPages = getTotalPages();
      const progress = ((currentPage + 1) / totalPages) * 100;
      progressBar.style.width = `${progress}%`;
    }

    // Animar la barra de progreso durante el autoplay
    function animateProgressBar() {
      if (!progressBar) return;
      let progress = 0;
      const increment = 100 / (autoplayDuration / 50); // Actualizar cada 50ms
      
      clearInterval(progressInterval);
      progressInterval = window.setInterval(() => {
        progress += increment;
        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }
        // No actualizamos la barra aquí para evitar conflictos
      }, 50);
    }

    // Actualizar la posición del carousel
    function updateCarousel() {
      if (!track) return;
      const translateX = -(currentIndex * (100 / newsPerView));
      track.style.transform = `translateX(${translateX}%)`;
      updateDots();
      updateProgressBar();
    }

    // Actualizar indicadores de puntos
    function updateDots() {
      if (!dotsContainer) return;
      const dots = dotsContainer.children;
      const currentPage = Math.floor(currentIndex / newsPerView);
      
      Array.from(dots).forEach((dot, index) => {
        if (index === currentPage) {
          (dot as HTMLElement).className = 'w-8 h-3 rounded-full bg-blue-600 transition-all duration-300';
        } else {
          (dot as HTMLElement).className = 'w-3 h-3 rounded-full bg-gray-300 hover:bg-gray-400 transition-all duration-300';
        }
      });
    }

    // Ir a una página específica
    function goToPage(pageIndex: number) {
      currentIndex = pageIndex * newsPerView;
      const maxIndex = totalNews - newsPerView;
      if (currentIndex > maxIndex) {
        currentIndex = maxIndex;
      }
      updateCarousel();
      resetAutoplay();
    }

    // Ir al siguiente conjunto de noticias
    function goNext() {
      const maxIndex = totalNews - newsPerView;
      if (currentIndex < maxIndex) {
        currentIndex += newsPerView;
        if (currentIndex > maxIndex) {
          currentIndex = maxIndex;
        }
      } else {
        currentIndex = 0; // Volver al inicio
      }
      updateCarousel();
    }

    // Ir al conjunto anterior de noticias
    function goPrev() {
      if (currentIndex > 0) {
        currentIndex -= newsPerView;
        if (currentIndex < 0) {
          currentIndex = 0;
        }
      } else {
        // Ir al final
        const maxIndex = totalNews - newsPerView;
        currentIndex = maxIndex;
      }
      updateCarousel();
    }

    // Autoplay mejorado
    function startAutoplay() {
      stopAutoplay();
      autoplayInterval = window.setInterval(() => {
        goNext();
      }, autoplayDuration);
      animateProgressBar();
    }

    function stopAutoplay() {
      clearInterval(autoplayInterval);
      clearInterval(progressInterval);
    }

    function resetAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Event listeners
    nextBtn.addEventListener('click', () => {
      goNext();
      resetAutoplay();
    });

    prevBtn.addEventListener('click', () => {
      goPrev();
      resetAutoplay();
    });

    // Pausar autoplay al hacer hover
    if (track) {
      track.addEventListener('mouseenter', stopAutoplay);
      track.addEventListener('mouseleave', startAutoplay);
    }

    // Pausar también en los botones
    [prevBtn, nextBtn].forEach(btn => {
      btn.addEventListener('mouseenter', stopAutoplay);
      btn.addEventListener('mouseleave', startAutoplay);
    });

    // Manejar cambio de tamaño de ventana
    window.addEventListener('resize', () => {
      updateNewsPerView();
      currentIndex = 0; // Resetear al inicio en resize
      createDots();
      updateCarousel();
      resetAutoplay();
    });

    // Soporte para navegación con teclado
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        goPrev();
        resetAutoplay();
      } else if (e.key === 'ArrowRight') {
        goNext();
        resetAutoplay();
      }
    });

    // Soporte para gestos táctiles (swipe)
    let startX = 0;
    let endX = 0;

    track.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      stopAutoplay();
    });

    track.addEventListener('touchend', (e) => {
      endX = e.changedTouches[0].clientX;
      handleSwipe();
      startAutoplay();
    });

    function handleSwipe() {
      const threshold = 50;
      const diff = startX - endX;
      
      if (Math.abs(diff) > threshold) {
        if (diff > 0) {
          goNext(); // Swipe left - next
        } else {
          goPrev(); // Swipe right - previous
        }
      }
    }

    // Inicialización
    updateNewsPerView();
    createDots();
    updateCarousel();
    startAutoplay();
  });
</script>

<style>
  /* Estilos adicionales para mejorar la experiencia */
  #news-carousel-container {
    touch-action: pan-y pinch-zoom;
  }

  /* Smooth scroll behavior */
  #news-track {
    will-change: transform;
  }

  /* Hover effects para los controles */
  button:focus {
    outline: 2px solid #3B82F6;
    outline-offset: 2px;
  }

  /* Animaciones suaves para las tarjetas */
  #news-track > div {
    transition: transform 0.3s ease;
  }

  /* Efecto de pausa visual en hover */
  #news-carousel-container:hover #news-track {
    animation-play-state: paused;
  }

  /* Optimización para dispositivos móviles */
  @media (max-width: 768px) {
    #news-prev-btn, #news-next-btn {
      padding: 0.5rem;
    }
    
    #news-prev-btn svg, #news-next-btn svg {
      width: 1rem;
      height: 1rem;
    }
  }

  /* Animación de aparición para las noticias */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Aplicar animación con delay escalonado */
  #news-track > div:nth-child(1) { animation: fadeInUp 0.6s ease-out 0.1s both; }
  #news-track > div:nth-child(2) { animation: fadeInUp 0.6s ease-out 0.2s both; }
  #news-track > div:nth-child(3) { animation: fadeInUp 0.6s ease-out 0.3s both; }

  /* Indicador de carga para la barra de progreso */
  #progress-bar {
    background: linear-gradient(90deg, #3B82F6, #1E40AF);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }
</style>
